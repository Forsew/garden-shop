<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/png">
    <title>GardenSpace - –ñ—É—Ä–Ω–∞–ª —É—Ä–æ–∂–∞—è</title>
</head>
<body>
    <header>
        <div class="container">
            <h1>ü™¥ GardenSpace</h1>
            <nav>
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="products.html">–ü—Ä–æ–¥—É–∫—Ü–∏—è</a>
                <a href="brigades.html">–ë—Ä–∏–≥–∞–¥—ã</a>
                <a href="collectors.html">–°–±–æ—Ä—â–∏–∫–∏</a>
                <a href="harvest.html" class="active">–ñ—É—Ä–Ω–∞–ª —É—Ä–æ–∂–∞—è</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h2>–ñ—É—Ä–Ω–∞–ª —É—á–µ—Ç–∞ —Å–±–æ—Ä–∞ —É—Ä–æ–∂–∞—è</h2>
            <button class="btn btn-primary" onclick="showAddLog()">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-panel">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div id="stats" class="stats-grid">
                <div class="stat-card">
                    <h4>–í—Å–µ–≥–æ —Å–æ–±—Ä–∞–Ω–æ</h4>
                    <p id="totalQuantity">0 –∫–≥</p>
                </div>
                <div class="stat-card">
                    <h4>–ó–∞–ø–∏—Å–µ–π</h4>
                    <p id="totalLogs">0</p>
                </div>
            </div>
            <div id="cropStats"></div>
            <div id="brigadeStats"></div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters">
            <input type="date" id="startDate" onchange="loadLogs()">
            <input type="date" id="endDate" onchange="loadLogs()">
            <select id="brigadeFilter" onchange="loadLogs()">
                <option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>
            </select>
            <select id="collectorFilter" onchange="loadLogs()">
                <option value="">–í—Å–µ —Å–±–æ—Ä—â–∏–∫–∏</option>
            </select>
            <input type="text" id="cropFilter" placeholder="–ö—É–ª—å—Ç—É—Ä–∞" onchange="loadLogs()">
            <button class="btn" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ -->
        <div class="table-container">
            <table id="harvestTable">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°–±–æ—Ä—â–∏–∫</th>
                        <th>–ë—Ä–∏–≥–∞–¥–∞</th>
                        <th>–ö—É–ª—å—Ç—É—Ä–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥)</th>
                        <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
                        <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="harvestLogs"></tbody>
            </table>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div id="addLogModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addLogModal')">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ —Å–±–æ—Ä–µ</h3>
            <form id="addLogForm">
                <input type="date" id="logDate" required>
                <select id="logCollector" required onchange="updateBrigade()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–±–æ—Ä—â–∏–∫–∞</option>
                </select>
                <select id="logBrigade" disabled>
                    <option value="">–ë—Ä–∏–≥–∞–¥–∞ (–≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</option>
                </select>
                <input type="text" id="logCrop" placeholder="–ö—É–ª—å—Ç—É—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –û–≥—É—Ä—Ü—ã)" required>
                <input type="number" id="logQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–≥)" step="0.1" min="0.1" required>
                <select id="logQuality" required>
                    <option value="">–ö–ª–∞—Å—Å –∫–∞—á–µ—Å—Ç–≤–∞</option>
                    <option value="A">A - –í—ã—Å—à–∏–π</option>
                    <option value="B">B - –ü–µ—Ä–≤—ã–π</option>
                    <option value="C">C - –í—Ç–æ—Ä–æ–π</option>
                </select>
                <textarea id="logNotes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let allCollectors = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            const params = new URLSearchParams();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (start) params.append('start_date', start);
            if (end) params.append('end_date', end);
            
            try {
                const response = await fetch(`${API_URL}/api/harvest/stats/summary?${params}`);
                const stats = await response.json();
                
                document.getElementById('totalQuantity').textContent = `${stats.total_quantity.toFixed(1)} –∫–≥`;
                document.getElementById('totalLogs').textContent = stats.total_logs;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫—É–ª—å—Ç—É—Ä–∞–º
                const cropStats = document.getElementById('cropStats');
                cropStats.innerHTML = '<h4>–ü–æ –∫—É–ª—å—Ç—É—Ä–∞–º:</h4>' + 
                    stats.by_crop.map(c => `<p>${c.crop}: ${c.quantity.toFixed(1)} –∫–≥</p>`).join('');
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–∏–≥–∞–¥–∞–º
                const brigadeStats = document.getElementById('brigadeStats');
                brigadeStats.innerHTML = '<h4>–ü–æ –±—Ä–∏–≥–∞–¥–∞–º:</h4>' + 
                    stats.by_brigade.map(b => `<p>${b.brigade}: ${b.quantity.toFixed(1)} –∫–≥</p>`).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–∏–≥–∞–¥
        async function loadBrigades() {
            try {
                const response = await fetch(`${API_URL}/api/brigades/`);
                const brigades = await response.json();
                
                const filter = document.getElementById('brigadeFilter');
                filter.innerHTML = '<option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>';
                brigades.forEach(b => {
                    filter.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∏–≥–∞–¥:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–±–æ—Ä—â–∏–∫–æ–≤
        async function loadCollectors() {
            try {
                const response = await fetch(`${API_URL}/api/brigades/collectors`);
                allCollectors = await response.json();
                
                const filter = document.getElementById('collectorFilter');
                const select = document.getElementById('logCollector');
                
                filter.innerHTML = '<option value="">–í—Å–µ —Å–±–æ—Ä—â–∏–∫–∏</option>';
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–±–æ—Ä—â–∏–∫–∞</option>';
                
                allCollectors.forEach(c => {
                    filter.innerHTML += `<option value="${c.id}">${c.full_name} (${c.brigade_name})</option>`;
                    select.innerHTML += `<option value="${c.id}" data-brigade="${c.brigade_id}">${c.full_name} (${c.brigade_name})</option>`;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–±–æ—Ä—â–∏–∫–æ–≤:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–∏–≥–∞–¥—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–±–æ—Ä—â–∏–∫–∞
        function updateBrigade() {
            const collectorSelect = document.getElementById('logCollector');
            const brigadeSelect = document.getElementById('logBrigade');
            const selectedOption = collectorSelect.options[collectorSelect.selectedIndex];
            
            if (selectedOption.value) {
                const brigadeId = selectedOption.getAttribute('data-brigade');
                const collector = allCollectors.find(c => c.id == selectedOption.value);
                
                brigadeSelect.innerHTML = `<option value="${brigadeId}">${collector.brigade_name}</option>`;
                brigadeSelect.value = brigadeId;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞
        async function loadLogs() {
            const params = new URLSearchParams();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const brigade = document.getElementById('brigadeFilter').value;
            const collector = document.getElementById('collectorFilter').value;
            const crop = document.getElementById('cropFilter').value;
            
            if (start) params.append('start_date', start);
            if (end) params.append('end_date', end);
            if (brigade) params.append('brigade_id', brigade);
            if (collector) params.append('collector_id', collector);
            if (crop) params.append('crop_type', crop);
            
            try {
                const response = await fetch(`${API_URL}/api/harvest/?${params}`);
                const logs = await response.json();
                
                const tbody = document.getElementById('harvestLogs');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.harvest_date).toLocaleDateString('ru-RU')}</td>
                        <td>${log.collector_name}</td>
                        <td>${log.brigade_name}</td>
                        <td>${log.crop_type}</td>
                        <td>${log.quantity}</td>
                        <td><span class="quality-badge quality-${log.quality_grade}">${log.quality_grade}</span></td>
                        <td>${log.notes || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteLog(${log.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `).join('');
                
                loadStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        document.getElementById('addLogForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                harvest_date: document.getElementById('logDate').value,
                collector_id: parseInt(document.getElementById('logCollector').value),
                brigade_id: parseInt(document.getElementById('logBrigade').value),
                crop_type: document.getElementById('logCrop').value,
                quantity: parseFloat(document.getElementById('logQuantity').value),
                quality_grade: document.getElementById('logQuality').value,
                notes: document.getElementById('logNotes').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/harvest/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('addLogModal');
                    loadLogs();
                    alert('–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    alert(error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        async function deleteLog(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/harvest/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadLogs();
                    alert('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞!');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function resetFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('brigadeFilter').value = '';
            document.getElementById('collectorFilter').value = '';
            document.getElementById('cropFilter').value = '';
            loadLogs();
        }

        function showAddLog() {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('logDate').valueAsDate = new Date();
            document.getElementById('addLogModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadBrigades();
        loadCollectors();
        loadLogs();
    </script>
</body>
</html>