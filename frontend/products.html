<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/png">
    <title>GardenSpace - –ü—Ä–æ–¥—É–∫—Ü–∏—è</title>
</head>
<body>
    <header>
        <div class="container">
            <h1>ü™¥ GardenSpace</h1>
            <nav>
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="products.html" class="active">–ü—Ä–æ–¥—É–∫—Ü–∏—è</a>
                <a href="brigades.html">–ë—Ä–∏–≥–∞–¥—ã</a>
                <a href="collectors.html">–°–±–æ—Ä—â–∏–∫–∏</a>
                <a href="harvest.html">–ñ—É—Ä–Ω–∞–ª —É—Ä–æ–∂–∞—è</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h2>–ü—Ä–æ–¥—É–∫—Ü–∏—è</h2>
            <button class="btn btn-primary" onclick="showAddProduct()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        </div>

        <div class="filters">
            <label>
                –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
                <select id="categoryFilter" onchange="loadProducts()">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                </select>
            </label>
            <button class="btn" onclick="showAddCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        </div>

        <div id="productsList" class="products-grid"></div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <form id="addProductForm">
                <input type="text" id="productName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                <textarea id="productDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                <input type="number" id="productPrice" placeholder="–¶–µ–Ω–∞" step="0.01" required>
                <input type="number" id="productStock" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="0" required>
                <select id="productCategory" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                </select>
                <input type="url" id="productImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCategoryModal')">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
            <form id="addCategoryForm">
                <input type="text" id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required>
                <textarea id="categoryDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/api/products/categories`);
                const categories = await response.json();
                
                const filterSelect = document.getElementById('categoryFilter');
                const productSelect = document.getElementById('productCategory');
                
                filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
                productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                
                categories.forEach(cat => {
                    filterSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    productSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        async function loadProducts() {
            const categoryId = document.getElementById('categoryFilter').value;
            const url = categoryId ? `${API_URL}/api/products/?category_id=${categoryId}` : `${API_URL}/api/products/`;
            
            try {
                const response = await fetch(url);
                const products = await response.json();
                
                const list = document.getElementById('productsList');
                list.innerHTML = products.map(p => `
                    <div class="product-card">
                        ${p.image_url ? `<img src="${p.image_url}" alt="${p.name}">` : '<div class="no-image">–ù–µ—Ç —Ñ–æ—Ç–æ</div>'}
                        <h3>${p.name}</h3>
                        <p class="category-badge">${p.category.name}</p>
                        <p>${p.description || ''}</p>
                        <div class="product-info">
                            <span class="price">${p.price} ‚ÇΩ</span>
                            <span class="stock">–ù–∞ —Å–∫–ª–∞–¥–µ: ${p.stock}</span>
                        </div>
                        <button class="btn btn-danger" onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDesc').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/products/categories`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('addCategoryModal');
                    loadCategories();
                    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                } else {
                    const error = await response.json();
                    alert(error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDesc').value || null,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category_id: parseInt(document.getElementById('productCategory').value),
                image_url: document.getElementById('productImage').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/products/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('addProductModal');
                    loadProducts();
                    alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    alert(error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteProduct(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/products/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadProducts();
                    alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function showAddProduct() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        function showAddCategory() {
            document.getElementById('addCategoryModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCategories();
        loadProducts();
    </script>
</body>
</html>