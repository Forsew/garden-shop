<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/png">
    <title>GardenSpace - –°–±–æ—Ä—â–∏–∫–∏</title>
</head>
<body>
    <header>
        <div class="container">
            <h1>ü™¥ GardenSpace</h1>
            <nav>
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="products.html">–ü—Ä–æ–¥—É–∫—Ü–∏—è</a>
                <a href="brigades.html">–ë—Ä–∏–≥–∞–¥—ã</a>
                <a href="collectors.html" class="active">–°–±–æ—Ä—â–∏–∫–∏</a>
                <a href="harvest.html">–ñ—É—Ä–Ω–∞–ª —É—Ä–æ–∂–∞—è</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="page-header">
            <h2>–°–±–æ—Ä—â–∏–∫–∏ —É—Ä–æ–∂–∞—è</h2>
            <button class="btn btn-primary" onclick="showAddCollector()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä—â–∏–∫–∞</button>
        </div>

        <div class="filters">
            <label>
                –ë—Ä–∏–≥–∞–¥–∞:
                <select id="brigadeFilter" onchange="loadCollectors()">
                    <option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>
                </select>
            </label>
        </div>

        <div id="collectorsList" class="collectors-grid"></div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–±–æ—Ä—â–∏–∫–∞ -->
    <div id="addCollectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCollectorModal')">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä—â–∏–∫–∞</h3>
            <form id="addCollectorForm">
                <input type="text" id="collectorName" placeholder="–§–ò–û" required>
                <input type="number" id="collectorYear" placeholder="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" min="1950" max="2010" required>
                <select id="collectorBrigade" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥—É</option>
                </select>
                <textarea id="collectorDesc" placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞"></textarea>
                <input type="url" id="collectorPhoto" placeholder="URL —Ñ–æ—Ç–æ">
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editCollectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editCollectorModal')">&times;</span>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–±–æ—Ä—â–∏–∫–∞</h3>
            <form id="editCollectorForm">
                <input type="hidden" id="editCollectorId">
                <input type="text" id="editCollectorName" placeholder="–§–ò–û" required>
                <input type="number" id="editCollectorYear" placeholder="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" min="1950" max="2010" required>
                <select id="editCollectorBrigade" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥—É</option>
                </select>
                <textarea id="editCollectorDesc" placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞"></textarea>
                <input type="url" id="editCollectorPhoto" placeholder="URL —Ñ–æ—Ç–æ">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const urlParams = new URLSearchParams(window.location.search);
        const brigadeFromUrl = urlParams.get('brigade');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–∏–≥–∞–¥
        async function loadBrigades() {
            try {
                const response = await fetch(`${API_URL}/api/brigades/`);
                const brigades = await response.json();
                
                const filterSelect = document.getElementById('brigadeFilter');
                const addSelect = document.getElementById('collectorBrigade');
                const editSelect = document.getElementById('editCollectorBrigade');
                
                filterSelect.innerHTML = '<option value="">–í—Å–µ –±—Ä–∏–≥–∞–¥—ã</option>';
                addSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥—É</option>';
                editSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–∏–≥–∞–¥—É</option>';
                
                brigades.forEach(b => {
                    filterSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    addSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    editSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });

                if (brigadeFromUrl) {
                    filterSelect.value = brigadeFromUrl;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∏–≥–∞–¥:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–±–æ—Ä—â–∏–∫–æ–≤
        async function loadCollectors() {
            const brigadeId = document.getElementById('brigadeFilter').value;
            const url = brigadeId ? `${API_URL}/api/brigades/collectors?brigade_id=${brigadeId}` : `${API_URL}/api/brigades/collectors`;
            
            try {
                const response = await fetch(url);
                const collectors = await response.json();
                
                const list = document.getElementById('collectorsList');
                list.innerHTML = collectors.map(c => `
                    <div class="collector-card">
                        ${c.photo ? `<img src="${c.photo}" alt="${c.full_name}">` : '<div class="no-photo">üì∑</div>'}
                        <h3>${c.full_name}</h3>
                        <p class="badge">${c.brigade_name}</p>
                        <p><strong>–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> ${c.birth_year}</p>
                        ${c.personal_characteristic ? `<p class="description">${c.personal_characteristic}</p>` : ''}
                        <div class="actions">
                            <button class="btn btn-sm" onclick="editCollector(${c.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCollector(${c.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–±–æ—Ä—â–∏–∫–æ–≤:', error);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–±–æ—Ä—â–∏–∫–∞
        document.getElementById('addCollectorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                full_name: document.getElementById('collectorName').value,
                birth_year: parseInt(document.getElementById('collectorYear').value),
                brigade_id: parseInt(document.getElementById('collectorBrigade').value),
                personal_characteristic: document.getElementById('collectorDesc').value || null,
                photo: document.getElementById('collectorPhoto').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/brigades/collectors`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('addCollectorModal');
                    loadCollectors();
                    alert('–°–±–æ—Ä—â–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    alert(error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä—â–∏–∫–∞
        async function editCollector(id) {
            try {
                const response = await fetch(`${API_URL}/api/brigades/collectors/${id}`);
                const collector = await response.json();
                
                document.getElementById('editCollectorId').value = collector.id;
                document.getElementById('editCollectorName').value = collector.full_name;
                document.getElementById('editCollectorYear').value = collector.birth_year;
                document.getElementById('editCollectorBrigade').value = collector.brigade_id;
                document.getElementById('editCollectorDesc').value = collector.personal_characteristic || '';
                document.getElementById('editCollectorPhoto').value = collector.photo || '';
                
                document.getElementById('editCollectorModal').style.display = 'block';
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        document.getElementById('editCollectorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editCollectorId').value;
            const data = {
                full_name: document.getElementById('editCollectorName').value,
                birth_year: parseInt(document.getElementById('editCollectorYear').value),
                brigade_id: parseInt(document.getElementById('editCollectorBrigade').value),
                personal_characteristic: document.getElementById('editCollectorDesc').value || null,
                photo: document.getElementById('editCollectorPhoto').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/brigades/collectors/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('editCollectorModal');
                    loadCollectors();
                    alert('–°–±–æ—Ä—â–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    const error = await response.json();
                    alert(error.detail);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–±–æ—Ä—â–∏–∫–∞
        async function deleteCollector(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–±–æ—Ä—â–∏–∫–∞?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/brigades/collectors/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadCollectors();
                    alert('–°–±–æ—Ä—â–∏–∫ —É–¥–∞–ª–µ–Ω!');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function showAddCollector() {
            document.getElementById('addCollectorModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadBrigades();
        loadCollectors();
    </script>
</body>
</html>